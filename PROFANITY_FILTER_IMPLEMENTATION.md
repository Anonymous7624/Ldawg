# Profanity Filter Implementation - Complete

## ✅ Implementation Complete

I've successfully added a strict profanity/slur filter to the global chat (`apps/pi-global`) with server-side filtering, strikes, and escalating mutes as specified.

## What Was Implemented

### 1. Server-Side Filter (Mandatory) ✓
- **Location**: `apps/pi-global/server.js`
- **Filtering happens BEFORE broadcasting** in the text message handler
- **Replacement**: Banned terms replaced with "-" repeated to match term length
  - Example: `"fuck"` → `"----"`
- **Case-insensitive**: Works regardless of capitalization
- **Punctuation handling**: `"fuck!"` → `"----!"`
- **Broadcast behavior**: Sanitized message is broadcast (original never sent)

### 2. Strikes + Mutes ✓
- **Strike system**: +1 strike per message containing banned terms (not per word)
- **Mute rules**:
  - Strikes 1-4: Warning only (no mute)
  - **Strike 5: 15 seconds** mute
  - Strikes 6-7: 15 seconds mute (continues)
  - **Strike 8: 60 seconds** mute
  - **Strike 9+: Doubles** each time (120s, 240s, 480s, ...)
  - **Cap: 2 days maximum**

- **While muted**:
  - Server rejects messages with `profanity_muted` response
  - Client shows system notice with remaining mute time and strike count
  - Send button disabled in UI

### 3. Cookie-Based State ✓
- **User identification**: `gc_sid` cookie (anonymous ID)
  - Generated by server if missing
  - Persists 1 year
- **Persistence**: Strikes and muteUntil stored in cookies
  - `gc_strikes`: Strike count
  - `gc_muteUntil`: Mute expiration timestamp
- **Server as source of truth**:
  - In-memory Map keyed by `gc_sid`: `{strikes, muteUntil, lastMuteSeconds}`
  - Cookies loaded on connect but server validates/clamps values
  - Server state synced to cookies after each strike

### 4. Banned Words List ✓
- **File**: `apps/pi-global/banned-words.txt`
- **Format**: One term per line, case-insensitive
- **Comments**: Lines starting with `#` ignored
- **Loading**: Loaded at server startup
- **Starter list**: Includes test words (damn, hell, crap, stupid, idiot, dumb)
- **Note**: You should expand this with real profanity/slurs

### 5. UI Rule Text ✓
- **Location**: `index.html` (rules sidebar)
- **Updated with**:
  - "No profanity, slurs, or hate speech."
  - "No impersonation."
  - "No spamming." (existing rule)
  - "Violations result in strikes and timed mutes."

## Files Changed

### New Files Created
1. **`apps/pi-global/banned-words.txt`** - Banned words list
2. **`apps/pi-global/PROFANITY_FILTER_SUMMARY.md`** - Full documentation
3. **`apps/pi-global/PROFANITY_FILTER_TESTING.md`** - Comprehensive test guide
4. **`apps/pi-global/QUICK_REFERENCE.md`** - Quick reference card

### Modified Files
1. **`apps/pi-global/server.js`** - Profanity filter logic
2. **`apps/pi-global/package.json`** - Added `cookie-parser` dependency
3. **`index.html`** - Client-side mute handling and rules text

## Dependencies Added

```json
"cookie-parser": "^1.4.6"
```

Install with:
```bash
cd apps/pi-global
npm install
```

## Quick Test Steps

### Test 1: Message Triggers Strike

**Steps:**
1. Open the global chat in your browser
2. Enter a nickname (e.g., "Tester")
3. Type: `"This is damn annoying"`
4. Click Send

**Expected:**
- Message appears as: `"This is ---- annoying"`
- Toast notification: `"Strike 1: Warning issued"`
- Server log shows: `[PROFANITY] Found 1 banned term(s) in message`

### Test 2: Confirm 5-Strike Mute (15 seconds)

**Steps:**
1. Send 4 more messages with banned words (total 5 strikes)
2. On the 5th message, observe the response

**Expected:**
- Toast: `"Strike 5: Muted for 15s"`
- Status bar: `"Muted for profanity (Strike 5) - XXs remaining"`
- Send button disabled
- Countdown updates every second
- After 15 seconds: mute expires, send button re-enabled

### Test 3: Confirm 8-Strike Mute (60 seconds)

**Steps:**
1. Wait for first mute to expire (15s)
2. Send 3 more profanity messages (strikes 6, 7, 8)
3. At strike 8, observe the mute duration

**Expected:**
- Strikes 6 & 7: 15-second mutes
- **Strike 8: 60-second mute**
- Status bar: `"Muted for profanity (Strike 8) - 1:00 remaining"`
- Countdown shows minutes:seconds format

### Test 4: Verify Persistence Across Reloads

**Steps:**
1. Accumulate 3 strikes
2. Refresh the page
3. Check browser console
4. Send another profanity message

**Expected:**
- Console shows: `[PROFANITY] Initial state: strikes=3, muteUntil=0`
- Next profanity gives **Strike 4** (not Strike 1)
- Strikes persisted in `gc_strikes` cookie

### Test 5: Verify Cookie-Based User ID

**Steps:**
1. Open chat in Browser 1, get some strikes
2. Open chat in Browser 2 (or Incognito)
3. Send profanity in Browser 2

**Expected:**
- Browser 1 and 2 have different `gc_sid` cookies
- Browser 2 starts at Strike 1 (independent counter)
- Each browser/user has separate state

## Deployment Instructions

### 1. Install Dependencies
```bash
cd apps/pi-global
npm install
```

### 2. Customize Banned Words
```bash
nano banned-words.txt
```
Add real profanity, slurs, and offensive terms (one per line, lowercase).

### 3. Restart Server
```bash
# If using PM2:
npm run pm2:restart

# Or regular start:
npm start
```

### 4. Verify Logs
```bash
# Check for:
[PROFANITY] Loaded X banned words from banned-words.txt
```

### 5. Test in Browser
- Open the global chat
- Send test messages with banned words
- Verify filtering and strikes work

## Server Logs to Monitor

Watch for these log entries:

```
[STARTUP] ✓ Loaded 6 banned words from banned-words.txt
[CONNECT] Client has gc_sid: abcd1234...
[CONNECT] Profanity state: strikes=0, muted=false
[PROFANITY] Found 1 banned term(s) in message from Tester: damn
[PROFANITY] Strike 1 issued (no mute yet)
[PROFANITY] Strike 5 issued, muted for 15s
[PROFANITY] Client xyz is muted (14s remaining, 5 strikes)
```

## Browser Cookies to Check

Use DevTools → Application → Cookies to inspect:

- **`gc_sid`**: User ID (UUID, 1 year)
- **`gc_strikes`**: Strike count (integer)
- **`gc_muteUntil`**: Mute expiration (epoch milliseconds)

## What Was NOT Implemented

As per your requirements, the following were **intentionally not added**:

- ❌ No login system
- ❌ No reporting features
- ❌ No admin tools or dashboard
- ❌ No complex systems

The implementation is **simple and focused** on profanity filtering only.

## Key Features

✅ **Server-side filtering** (mandatory)  
✅ **Escalating mute schedule** (5 strikes → 15s, 8 strikes → 60s, then doubling)  
✅ **Cookie-based persistence** (gc_sid for user ID)  
✅ **In-memory server state** (source of truth)  
✅ **External banned words file** (easy to edit)  
✅ **Client UI updates** (rules text, mute countdown, disabled send button)  
✅ **All existing functionality preserved** (upload, chat, delete, etc.)  

## Documentation

- **`PROFANITY_FILTER_SUMMARY.md`** - Complete implementation details
- **`PROFANITY_FILTER_TESTING.md`** - 12 detailed test scenarios
- **`QUICK_REFERENCE.md`** - Quick lookup for common operations

## Next Steps

1. **Install dependencies**: `npm install` in `apps/pi-global/`
2. **Add real banned words**: Edit `banned-words.txt` with actual profanity/slurs
3. **Deploy**: Restart the server
4. **Test**: Follow the test steps above
5. **Monitor**: Watch server logs for profanity events

## Support

If you encounter any issues:
1. Check server logs for `[PROFANITY]` entries
2. Verify cookies are set in browser DevTools
3. Confirm `banned-words.txt` has content
4. Ensure server was restarted after changes
5. Refer to `PROFANITY_FILTER_TESTING.md` for detailed scenarios

---

**Implementation Status**: ✅ Complete and Ready for Deployment
